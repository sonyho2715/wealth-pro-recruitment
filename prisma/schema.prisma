generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// ============================================
// MULTI-TENANT SAAS FOUNDATION
// ============================================

model Organization {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique // for URLs: app.com/org/[slug]

  // Branding (white-label)
  logo          String?
  primaryColor  String?  @default("#3B82F6")
  secondaryColor String? @default("#1E40AF")

  // Subscription
  plan          PlanType @default(FREE)
  planExpiresAt DateTime?
  stripeCustomerId String?
  stripeSubscriptionId String?

  // Feature flags based on plan
  maxAgents     Int      @default(1)
  maxContacts   Int      @default(100)
  smsEnabled    Boolean  @default(false)
  eSignEnabled  Boolean  @default(false)

  // Twilio SMS Configuration (per org)
  twilioAccountSid   String?
  twilioAuthToken    String?
  twilioPhoneNumber  String?

  // White-Label Database Isolation
  // When tenantDatabaseProvisioned is true, this org has its own database
  tenantDatabaseUrl         String?   // Connection URL to dedicated database
  tenantDatabaseProvisioned Boolean   @default(false)
  tenantDatabaseProvisionedAt DateTime?
  tenantRailwayProjectId    String?   // Railway project ID for management

  // Relations
  agents            Agent[]
  contacts          Contact[]
  scripts           Script[]
  disclosures       Disclosure[]
  trainingModules   TrainingModule[]
  messages          Message[]

  // BSCpro feature relations
  bpms              BPM[]
  recruits          Recruit[]
  productions       Production[]
  matchupRequests   MatchupRequest[]
  teamInvites       TeamInvite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

enum PlanType {
  FREE          // 1 agent, 100 contacts, no SMS
  STARTER       // 3 agents, 500 contacts, SMS
  PROFESSIONAL  // 10 agents, 2000 contacts, SMS + eSign
  ENTERPRISE    // Unlimited, all features, white-label
}

// ============================================
// WARM MARKET / CONTACTS SYSTEM
// ============================================

model Contact {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Basic info
  firstName       String
  lastName        String
  phone           String?
  email           String?

  // Warm market specifics
  relationship    ContactRelationship?
  temperature     ContactTemperature @default(COLD)
  source          ContactSource @default(MANUAL)

  // Relationship mapping (who referred them)
  referredById    String?
  referredBy      Contact? @relation("ContactReferrals", fields: [referredById], references: [id], onDelete: SetNull)
  referrals       Contact[] @relation("ContactReferrals")

  // Conversion tracking
  prospectId      String?  @unique
  prospect        Prospect? @relation(fields: [prospectId], references: [id], onDelete: SetNull)
  convertedAt     DateTime?

  // Follow-up tracking
  lastContactedAt DateTime?
  nextFollowUpAt  DateTime?
  followUpNotes   String?

  // Metadata
  notes           String?
  tags            String[] @default([])
  birthday        DateTime?
  occupation      String?
  company         String?

  // Relations
  messages        Message[]
  bpmGuests       BPMGuest[]  // Guests invited to BPM events

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([agentId])
  @@index([temperature])
  @@index([nextFollowUpAt])
  // Composite indexes for filtering and dashboard queries
  @@index([organizationId, agentId])
  @@index([agentId, temperature])
  @@index([organizationId, temperature])
}

enum ContactRelationship {
  FAMILY
  FRIEND
  COWORKER
  NEIGHBOR
  CHURCH
  GYM
  SOCIAL_MEDIA
  REFERRAL
  COLD_LEAD
  OTHER
}

enum ContactTemperature {
  COLD           // Never contacted
  WARMING        // Initial contact made
  WARM           // Interested, in conversation
  HOT            // Ready for presentation
  CONVERTED      // Became prospect/client
  NOT_INTERESTED // Declined
}

enum ContactSource {
  MANUAL         // Manually added
  IMPORT         // Phone/CSV import
  REFERRAL       // From another contact
  WEBSITE        // From website form
  SOCIAL         // Social media
}

// ============================================
// SMS / MESSAGING SYSTEM
// ============================================

model Message {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  contactId       String?
  contact         Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Message details
  type            MessageType
  direction       MessageDirection
  content         String   @db.Text

  // Recipient info (for when contact is deleted)
  recipientPhone  String?
  recipientEmail  String?
  recipientName   String?

  // Status tracking
  status          MessageStatus @default(PENDING)
  errorMessage    String?

  // External IDs
  twilioSid       String?
  emailMessageId  String?

  // Timestamps
  sentAt          DateTime?
  deliveredAt     DateTime?
  readAt          DateTime?

  createdAt       DateTime @default(now())

  @@index([organizationId])
  @@index([agentId])
  @@index([contactId])
  @@index([status])
}

enum MessageType {
  SMS
  EMAIL
  WHATSAPP
}

enum MessageDirection {
  OUTBOUND
  INBOUND
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

// ============================================
// SCRIPTS / TEMPLATES LIBRARY
// ============================================

model Script {
  id              String   @id @default(cuid())
  organizationId  String?  // null = system default
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  title           String
  description     String?
  content         String   @db.Text
  category        ScriptCategory

  // Organization
  tags            String[] @default([])
  isSystem        Boolean  @default(false) // System templates can't be deleted
  isActive        Boolean  @default(true)

  // Usage tracking
  usageCount      Int      @default(0)
  lastUsedAt      DateTime?

  // Creator
  createdById     String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([category])
}

enum ScriptCategory {
  PHONE_OPENING        // Initial call scripts
  PHONE_FOLLOW_UP      // Follow-up call scripts
  OBJECTION_HANDLING   // Common objections
  APPOINTMENT_SETTING  // Getting meetings
  PRESENTATION         // During presentation
  CLOSING              // Closing the deal
  RECRUITING           // Agent recruitment
  TEXT_TEMPLATE        // SMS templates
  EMAIL_TEMPLATE       // Email templates
  SOCIAL_MEDIA         // Social media posts/DMs
}

// ============================================
// COMPLIANCE / E-SIGNATURE SYSTEM
// ============================================

model Disclosure {
  id              String   @id @default(cuid())
  organizationId  String?  // null = system default
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  title           String
  description     String?
  content         String   @db.Text

  // Versioning
  version         Int      @default(1)
  isActive        Boolean  @default(true)

  // When is this required?
  requiredFor     DisclosureRequirement[]
  requiresSignature Boolean @default(true)

  // Relations
  signatures      DisclosureSignature[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
}

enum DisclosureRequirement {
  PROSPECT_INTAKE      // Before financial intake
  BEFORE_PRESENTATION  // Before showing numbers
  BEFORE_APPLICATION   // Before submitting app
  AGENT_ONBOARDING     // When agent joins
  ANNUAL_COMPLIANCE    // Yearly acknowledgment
}

model DisclosureSignature {
  id              String   @id @default(cuid())
  disclosureId    String
  disclosure      Disclosure @relation(fields: [disclosureId], references: [id], onDelete: Cascade)

  // Who signed
  signerType      SignerType
  signerId        String   // prospectId or agentId
  signerName      String
  signerEmail     String

  // Signature data
  signatureData   String   @db.Text // Base64 encoded signature image
  signatureType   SignatureType @default(DRAWN)

  // Audit trail
  ipAddress       String
  userAgent       String

  // Document snapshot
  disclosureVersion Int
  disclosureContent String @db.Text // Copy of content at time of signing

  signedAt        DateTime @default(now())

  @@index([disclosureId])
  @@index([signerId])
}

enum SignerType {
  PROSPECT
  AGENT
}

enum SignatureType {
  DRAWN          // Hand-drawn signature
  TYPED          // Typed name
  CLICK          // Click to sign
}

// ============================================
// TRAINING / ONBOARDING SYSTEM
// ============================================

model TrainingModule {
  id              String   @id @default(cuid())
  organizationId  String?  // null = system default
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  title           String
  description     String?
  content         String   @db.Text // Markdown or HTML

  // Media
  videoUrl        String?  // YouTube, Vimeo, etc.
  thumbnailUrl    String?
  duration        Int?     // in minutes

  // Organization
  category        TrainingCategory
  order           Int      @default(0)

  // Requirements
  requiredForRoles AgentRole[] @default([])
  prerequisiteIds  String[]    @default([]) // Must complete these first

  // Quiz (optional)
  hasQuiz         Boolean  @default(false)
  quizQuestions   Json?    // Array of {question, options, correctAnswer}
  passingScore    Int?     @default(70)

  // Status
  isSystem        Boolean  @default(false)
  isActive        Boolean  @default(true)

  // Relations
  completions     TrainingCompletion[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([category])
}

enum TrainingCategory {
  ONBOARDING         // Getting started
  PRODUCT_KNOWLEDGE  // Insurance products
  SALES_SKILLS       // Selling techniques
  COMPLIANCE         // Rules and regulations
  SYSTEM_TRAINING    // How to use the platform
  RECRUITING         // Building a team
  LEADERSHIP         // For managers
}

model TrainingCompletion {
  id              String   @id @default(cuid())
  moduleId        String
  module          TrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Progress
  status          CompletionStatus @default(IN_PROGRESS)
  progress        Int      @default(0) // 0-100

  // Quiz results
  quizScore       Int?
  quizAttempts    Int      @default(0)
  quizPassedAt    DateTime?

  // Timestamps
  startedAt       DateTime @default(now())
  completedAt     DateTime?

  @@unique([moduleId, agentId])
  @@index([agentId])
}

enum CompletionStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============================================
// PRESENTATION MODE DATA
// ============================================

model PresentationSession {
  id              String   @id @default(cuid())
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  prospectId      String
  prospect        Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  // Session tracking
  startedAt       DateTime @default(now())
  endedAt         DateTime?

  // Slides shown
  slidesViewed    String[] @default([])
  currentSlide    String?

  // Engagement metrics
  totalDuration   Int?     // seconds
  interactionCount Int     @default(0)

  // Device info
  deviceType      String?  // mobile, tablet, desktop
  userAgent       String?

  // Outcome
  outcome         PresentationOutcome?
  notes           String?

  @@index([agentId])
  @@index([prospectId])
}

enum PresentationOutcome {
  COMPLETED
  INTERRUPTED
  FOLLOW_UP_NEEDED
  APPLICATION_STARTED
  DECLINED
}

// ============================================
// CORE MODELS (UPDATED)
// ============================================

// Core prospect/client model
model Prospect {
  id        String   @id @default(cuid())
  email     String   @unique
  firstName String
  lastName  String
  phone     String?
  status    ProspectStatus @default(LEAD)
  stage     ProspectStage  @default(NEW)

  // Agent ownership (optional - prospects can self-register)
  agentId   String?
  agent     Agent?   @relation(fields: [agentId], references: [id], onDelete: SetNull)

  // Referral tracking
  referredByAgentId String?
  referredByAgent   Agent?   @relation("ReferredProspects", fields: [referredByAgentId], references: [id], onDelete: SetNull)
  referralSource    String?  // e.g., "link", "manual", "website"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  financialProfile FinancialProfile?
  insuranceNeeds   InsuranceNeed[]
  agentProjection  AgentProjection?
  comparisons      Comparison[]
  notes            Note[]
  activities       Activity[]
  commissions      Commission[]
  documents        Document[]
  sharedWith       ProspectShare[]

  // SaaS feature relations
  contact              Contact?             // Link from warm market
  presentationSessions PresentationSession[]

  @@index([agentId])
  @@index([referredByAgentId])
  // Composite indexes for pipeline and dashboard queries
  @@index([agentId, status])
  @@index([agentId, stage])
  @@index([status, stage])
}

enum ProspectStatus {
  LEAD
  QUALIFIED
  INSURANCE_CLIENT
  AGENT_PROSPECT
  LICENSED_AGENT
  INACTIVE
}

// Pipeline stages for tracking progress
enum ProspectStage {
  NEW              // Just added
  CONTACTED        // Initial contact made
  MEETING_SCHEDULED // Meeting booked
  NEEDS_ANALYSIS   // Financial analysis in progress
  PROPOSAL_SENT    // Proposal/recommendation sent
  NEGOTIATION      // Discussing terms
  CLOSED_WON       // Successfully converted
  CLOSED_LOST      // Did not convert
}

// Prospect sharing between agents
model ProspectShare {
  id           String   @id @default(cuid())
  prospectId   String
  prospect     Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  // Agent who shared
  sharedByAgentId String
  sharedByAgent   Agent  @relation("SharedByAgent", fields: [sharedByAgentId], references: [id], onDelete: Cascade)

  // Agent receiving access
  sharedWithAgentId String
  sharedWithAgent   Agent  @relation("SharedWithAgent", fields: [sharedWithAgentId], references: [id], onDelete: Cascade)

  // Permissions
  canEdit      Boolean @default(false)
  canViewOnly  Boolean @default(true)

  // Metadata
  note         String?
  sharedAt     DateTime @default(now())

  @@unique([prospectId, sharedWithAgentId])
  @@index([sharedByAgentId])
  @@index([sharedWithAgentId])
}

// Financial intake data
model FinancialProfile {
  id         String   @id @default(cuid())
  prospectId String   @unique
  prospect   Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  // Income
  annualIncome  Decimal @db.Decimal(12, 2)
  spouseIncome  Decimal? @db.Decimal(12, 2)
  otherIncome   Decimal? @db.Decimal(12, 2)

  // Monthly Expenses (detailed breakdown)
  monthlyExpenses Decimal @db.Decimal(12, 2)
  housingCost     Decimal @db.Decimal(12, 2)
  debtPayments    Decimal @db.Decimal(12, 2)
  utilities       Decimal @db.Decimal(12, 2) @default(0)
  food            Decimal @db.Decimal(12, 2) @default(0)
  transportation  Decimal @db.Decimal(12, 2) @default(0)
  insurance       Decimal @db.Decimal(12, 2) @default(0)
  childcare       Decimal @db.Decimal(12, 2) @default(0)
  entertainment   Decimal @db.Decimal(12, 2) @default(0)
  otherExpenses   Decimal @db.Decimal(12, 2) @default(0)

  // Assets
  savings       Decimal @db.Decimal(12, 2) @default(0)
  emergencyFund Decimal @db.Decimal(12, 2) @default(0)
  investments   Decimal @db.Decimal(12, 2) @default(0)
  retirement401k Decimal @db.Decimal(12, 2) @default(0)
  rothIra       Decimal @db.Decimal(12, 2) @default(0)
  pensionValue  Decimal @db.Decimal(12, 2) @default(0)
  hsaFsa        Decimal @db.Decimal(12, 2) @default(0)
  homeMarketValue Decimal @db.Decimal(12, 2) @default(0)  // Home market value (user input)
  homeEquity    Decimal @db.Decimal(12, 2) @default(0)    // Calculated: homeMarketValue - mortgage
  investmentProperty Decimal @db.Decimal(12, 2) @default(0)
  businessEquity Decimal @db.Decimal(12, 2) @default(0)
  otherAssets   Decimal @db.Decimal(12, 2) @default(0)

  // Liabilities
  mortgage     Decimal @db.Decimal(12, 2) @default(0)
  carLoans     Decimal @db.Decimal(12, 2) @default(0)
  studentLoans Decimal @db.Decimal(12, 2) @default(0)
  creditCards  Decimal @db.Decimal(12, 2) @default(0)
  personalLoans Decimal @db.Decimal(12, 2) @default(0)
  otherDebts   Decimal @db.Decimal(12, 2) @default(0)

  // Demographics
  age           Int
  spouseAge     Int?
  dependents    Int @default(0)
  retirementAge Int @default(65)
  occupation    String?
  spouseOccupation String?
  stateOfResidence String?

  // Tax Information
  federalTaxRate   Decimal @db.Decimal(5, 2) @default(22)
  stateTaxRate     Decimal @db.Decimal(5, 2) @default(5)
  capitalGainsTaxRate Decimal @db.Decimal(5, 2) @default(15)
  filingStatus     FilingStatus @default(SINGLE)

  // Monthly Contributions
  monthlySavingsContribution Decimal @db.Decimal(12, 2) @default(0)
  employer401kMatch Decimal @db.Decimal(5, 2) @default(0)  // Percentage

  // Social Security
  expectedSocialSecurity Decimal @db.Decimal(12, 2) @default(0)

  // Calculated fields
  netWorth      Decimal @db.Decimal(12, 2) @default(0)
  monthlyGap    Decimal @db.Decimal(12, 2) @default(0)
  protectionGap Decimal @db.Decimal(12, 2) @default(0)

  // Current insurance
  currentLifeInsurance Decimal @db.Decimal(12, 2) @default(0)
  currentDisability    Decimal @db.Decimal(12, 2) @default(0)

  // NEW: Protection Details
  liabilityInsurance    Decimal @db.Decimal(12, 2) @default(0)  // Umbrella/liability coverage
  hospitalDailyBenefit  Decimal @db.Decimal(12, 2) @default(0)  // Daily hospital indemnity
  spouseLifeInsurance   Decimal @db.Decimal(12, 2) @default(0)  // Spouse's life insurance
  annualInsuranceCosts  Decimal @db.Decimal(12, 2) @default(0)  // Total annual premiums
  hasWill               Boolean @default(false)
  hasTrust              Boolean @default(false)

  // NEW: Assets - Personal Property (separated from otherAssets)
  personalProperty      Decimal @db.Decimal(12, 2) @default(0)  // Vehicles, jewelry, collectibles

  // NEW: Liabilities - Tax and Business Debt
  taxesOwed             Decimal @db.Decimal(12, 2) @default(0)  // Back taxes, tax liens
  businessDebt          Decimal @db.Decimal(12, 2) @default(0)  // Business-related debt

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum FilingStatus {
  SINGLE
  MARRIED_FILING_JOINTLY
  MARRIED_FILING_SEPARATELY
  HEAD_OF_HOUSEHOLD
}

// Insurance recommendations
model InsuranceNeed {
  id         String   @id @default(cuid())
  prospectId String
  prospect   Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  type                InsuranceType
  recommendedCoverage Decimal @db.Decimal(12, 2)
  currentCoverage     Decimal @db.Decimal(12, 2) @default(0)
  gap                 Decimal @db.Decimal(12, 2)
  monthlyPremium      Decimal? @db.Decimal(12, 2)
  priority            Int
  reasoning           String

  createdAt DateTime @default(now())

  @@index([prospectId])
}

enum InsuranceType {
  TERM_LIFE
  WHOLE_LIFE
  UNIVERSAL_LIFE
  DISABILITY
  LONG_TERM_CARE
}

// Agent career projection
model AgentProjection {
  id         String   @id @default(cuid())
  prospectId String   @unique
  prospect   Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  // Input assumptions
  hoursPerWeek     Int @default(20)
  networkSize      Int @default(100)
  startDate        DateTime?

  // Projection data (JSON for flexibility)
  yearlyProjections Json

  // Summary figures
  year1Income   Decimal @db.Decimal(12, 2)
  year3Income   Decimal @db.Decimal(12, 2)
  year5Income   Decimal @db.Decimal(12, 2)
  lifetimeValue Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Side-by-side comparison scenarios
model Comparison {
  id         String   @id @default(cuid())
  prospectId String
  prospect   Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  name String @default("Default Comparison")

  // WITHOUT agent career projection
  baselineProjection     Json
  baselineRetirementAge  Int
  baselineNetWorthAt65   Decimal @db.Decimal(12, 2)

  // WITH agent career projection
  agentProjection        Json
  agentRetirementAge     Int
  agentNetWorthAt65      Decimal @db.Decimal(12, 2)

  // Difference highlights
  additionalIncome        Decimal @db.Decimal(12, 2)
  yearsEarlierRetirement  Int
  additionalNetWorth      Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([prospectId])
}

// CRM notes for follow-up
model Note {
  id         String   @id @default(cuid())
  prospectId String
  prospect   Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  content   String
  type      NoteType @default(GENERAL)
  createdBy String   @default("agent")

  createdAt DateTime @default(now())

  @@index([prospectId])
}

enum NoteType {
  GENERAL
  CALL
  MEETING
  FOLLOW_UP
  EMAIL
}

// Agent user for CRM access
model Agent {
  id           String @id @default(cuid())
  email        String @unique
  passwordHash String
  firstName    String
  lastName     String
  phone        String?
  licenseNumber String?
  role         AgentRole @default(AGENT)
  licenseDate  DateTime?
  monthlyGoal  Decimal? @db.Decimal(12, 2)

  // Multi-tenant organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Referral system (generated on first access if null)
  referralCode String? @unique

  // Team hierarchy
  uplineId     String?
  upline       Agent?   @relation("AgentHierarchy", fields: [uplineId], references: [id])
  downlines    Agent[]  @relation("AgentHierarchy")

  // Core CRM relations
  prospects         Prospect[]
  referredProspects Prospect[] @relation("ReferredProspects")
  activities        Activity[]
  commissions       Commission[]
  documents         Document[]
  sharedByMe        ProspectShare[] @relation("SharedByAgent")
  sharedWithMe      ProspectShare[] @relation("SharedWithAgent")

  // SaaS feature relations
  contacts             Contact[]
  messages             Message[]
  trainingCompletions  TrainingCompletion[]
  presentationSessions PresentationSession[]

  // BSCpro feature relations
  bpmInvites                BPMGuest[]       @relation("BPMInviter")
  recruits                  Recruit[]        @relation("RecruitedBy")
  trainees                  Recruit[]        @relation("FieldTrainerOf")
  productions               Production[]     @relation("WrittenBy")
  matchupRequestsMade       MatchupRequest[] @relation("MatchupRequestor")
  matchupRequestsReceived   MatchupRequest[] @relation("MatchupTrainer")
  teamInvitesSent           TeamInvite[]     @relation("InvitedBy")

  // Business Balance Sheet relations
  businessProspects         BusinessProspect[] @relation("BusinessProspects")
  referredBusinessProspects BusinessProspect[] @relation("ReferredBusinessProspects")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([uplineId])
  @@index([referralCode])
  // Composite indexes for common queries
  @@index([organizationId, email])
  @@index([organizationId, role])
}

enum AgentRole {
  AGENT
  MANAGER
  ADMIN
}

// Activity tracking for prospects
model Activity {
  id           String       @id @default(cuid())
  agentId      String
  agent        Agent        @relation(fields: [agentId], references: [id], onDelete: Cascade)
  prospectId   String?
  prospect     Prospect?    @relation(fields: [prospectId], references: [id], onDelete: SetNull)

  type         ActivityType
  title        String
  description  String?
  scheduledAt  DateTime?
  completedAt  DateTime?
  outcome      String?

  createdAt    DateTime     @default(now())

  @@index([agentId])
  @@index([prospectId])
  @@index([scheduledAt])
}

enum ActivityType {
  CALL
  MEETING
  EMAIL
  FOLLOW_UP
  PRESENTATION
  APPLICATION
  OTHER
}

// Commission tracking
model Commission {
  id           String           @id @default(cuid())
  agentId      String
  agent        Agent            @relation(fields: [agentId], references: [id], onDelete: Cascade)
  prospectId   String?
  prospect     Prospect?        @relation(fields: [prospectId], references: [id], onDelete: SetNull)

  productType  String           // Life, Disability, etc.
  policyNumber String?
  amount       Decimal          @db.Decimal(12, 2)
  status       CommissionStatus @default(PENDING)
  earnedDate   DateTime?
  paidDate     DateTime?
  notes        String?

  createdAt    DateTime         @default(now())

  @@index([agentId])
  @@index([status])
  @@index([earnedDate])
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CHARGEBACK
}

// Document storage
model Document {
  id           String       @id @default(cuid())
  agentId      String
  agent        Agent        @relation(fields: [agentId], references: [id], onDelete: Cascade)
  prospectId   String?
  prospect     Prospect?    @relation(fields: [prospectId], references: [id], onDelete: SetNull)

  name         String
  type         DocumentType @default(OTHER)
  url          String       // File path or URL
  size         Int?         // File size in bytes

  uploadedAt   DateTime     @default(now())

  @@index([agentId])
  @@index([prospectId])
}

enum DocumentType {
  APPLICATION
  POLICY
  ID_DOCUMENT
  FINANCIAL_STATEMENT
  OTHER
}

// Email templates for follow-ups
model EmailTemplate {
  id           String   @id @default(cuid())
  name         String
  subject      String
  body         String   @db.Text
  category     String   // follow_up, appointment, thank_you, etc.
  isActive     Boolean  @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// BPM (BUSINESS PRESENTATION MEETINGS) SYSTEM
// ============================================

model BPM {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Event details
  name            String
  date            DateTime
  location        String?
  address         String?
  isVirtual       Boolean  @default(false)
  virtualLink     String?

  // Goals
  inviteGoal      Int      @default(10)
  attendanceGoal  Int      @default(5)

  // Status
  status          BPMStatus @default(SCHEDULED)

  // Relations
  guests          BPMGuest[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([date])
}

enum BPMStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model BPMGuest {
  id              String   @id @default(cuid())
  bpmId           String
  bpm             BPM      @relation(fields: [bpmId], references: [id], onDelete: Cascade)

  // Inviter (agent who invited this guest)
  inviterId       String
  inviter         Agent    @relation("BPMInviter", fields: [inviterId], references: [id], onDelete: Cascade)

  // Guest info (can be linked to contact or standalone)
  contactId       String?
  contact         Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Guest details (for standalone or backup)
  guestName       String
  guestPhone      String?
  guestEmail      String?

  // Attendance tracking
  status          BPMGuestStatus @default(INVITED)
  arrived         Boolean  @default(false)
  arrivedAt       DateTime?
  confirmedAt     DateTime?

  // Follow-up
  isClient        Boolean  @default(false)
  isRecruit       Boolean  @default(false)
  rescheduled     Boolean  @default(false)
  notInterested   Boolean  @default(false)
  leftMessage     Boolean  @default(false)

  // Notes
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([bpmId])
  @@index([inviterId])
  @@index([status])
}

enum BPMGuestStatus {
  INVITED
  CONFIRMED
  RESCHEDULED
  NOT_INTERESTED
  ARRIVED
  NO_SHOW
}

// ============================================
// RECRUIT TRACKING SYSTEM (Speed Filters)
// ============================================

model Recruit {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Recruiter who brought them in
  recruiterId     String
  recruiter       Agent    @relation("RecruitedBy", fields: [recruiterId], references: [id], onDelete: Cascade)

  // Field trainer assigned
  fieldTrainerId  String?
  fieldTrainer    Agent?   @relation("FieldTrainerOf", fields: [fieldTrainerId], references: [id], onDelete: SetNull)

  // Basic info
  firstName       String
  lastName        String
  phone           String
  email           String?
  codeNumber      String?  // Agent code number once licensed

  // Location
  country         String   @default("USA")
  state           String?

  // Status
  status          RecruitStatus @default(ACTIVE)
  startDate       DateTime @default(now())

  // Onboarding milestones (BSCpro "Speed Filters")
  meetSpouse      Boolean  @default(false)
  meetSpouseDate  DateTime?
  submitLic       Boolean  @default(false)
  submitLicDate   DateTime?
  prospectList    Boolean  @default(false)
  prospectListDate DateTime?
  threeThreeThirty Boolean @default(false)  // 3-3-30 program
  threeThreeThirtyDate DateTime?
  fna             Boolean  @default(false)  // Financial Needs Analysis
  fnaDate         DateTime?
  fastStartSchool Boolean  @default(false)
  fastStartSchoolDate DateTime?

  // Licensing progress
  codeExpiryDate  DateTime?
  hoursCompleted  Int      @default(0)
  examPassed      Boolean  @default(false)
  examPassedDate  DateTime?
  fingerprinting  Boolean  @default(false)
  fingerprintDate DateTime?
  licenseIssued   Boolean  @default(false)
  licenseIssuedDate DateTime?

  // Notes and tags
  notes           String?
  tags            String[] @default([])

  // Relations
  productions     Production[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([recruiterId])
  @@index([status])
}

enum RecruitStatus {
  ACTIVE
  LICENSED
  INACTIVE
  NOT_INTERESTED
  FAST_START_COMPLETE
}

// ============================================
// PRODUCTION TRACKING SYSTEM
// ============================================

model Production {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Writing agent(s)
  writingAgentId  String
  writingAgent    Agent    @relation("WrittenBy", fields: [writingAgentId], references: [id], onDelete: Cascade)

  // Trainee (optional)
  traineeId       String?
  trainee         Recruit? @relation(fields: [traineeId], references: [id], onDelete: SetNull)
  isTrainee       Boolean  @default(false)

  // Client info
  clientName      String
  clientPhone     String?
  clientEmail     String?
  clientBirthday  DateTime?

  // Policy details
  provider        String?
  product         String?
  productType     ProductType?
  policyNumber    String?
  description     String?

  // Points/Premium
  totalPoints     Decimal  @db.Decimal(12, 2) @default(0)
  baseshopPoints  Decimal  @db.Decimal(12, 2) @default(0)
  premium         Decimal? @db.Decimal(12, 2)

  // Split (for multiple agents)
  splitRatio      Int      @default(100) // Percentage

  // Dates
  writtenDate     DateTime @default(now())
  dropDate        DateTime? // Case closing deadline

  // Status
  status          ProductionStatus @default(PENDING)

  // Advanced tracking (for persistency)
  advPaid         Boolean  @default(false)
  pd1Paid         Boolean  @default(false)
  pd2Paid         Boolean  @default(false)

  // Notes and tags
  notes           String?
  tags            String[] @default([])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([writingAgentId])
  @@index([writtenDate])
  @@index([status])
  // Composite indexes for reporting and leaderboard queries
  @@index([organizationId, writtenDate])
  @@index([organizationId, status])
  @@index([writingAgentId, writtenDate])
  @@index([writingAgentId, status])
}

enum ProductType {
  TERM_LIFE
  WHOLE_LIFE
  IUL
  ANNUITY
  DISABILITY
  LTC
  HEALTH
  AUTO
  HOME
  OTHER
}

enum ProductionStatus {
  PENDING
  SUBMITTED
  APPROVED
  ISSUED
  PAID
  CANCELLED
  CHARGEBACK
}

// ============================================
// MATCHUP / APPOINTMENT REQUESTS
// ============================================

model MatchupRequest {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Requesting agent
  requestingAgentId String
  requestingAgent Agent    @relation("MatchupRequestor", fields: [requestingAgentId], references: [id], onDelete: Cascade)

  // Assigned trainer (optional)
  assignedTrainerId String?
  assignedTrainer Agent?   @relation("MatchupTrainer", fields: [assignedTrainerId], references: [id], onDelete: SetNull)

  // Appointment details
  appointmentDate DateTime
  duration        Int      @default(30) // minutes
  appointmentType MatchupType
  isVirtual       Boolean  @default(false)

  // Location (if in-person)
  address         String?
  city            String?
  state           String?
  zip             String?

  // Contact info
  contactName     String
  contactPhone    String
  contactEmail    String?
  spouseName      String?

  // Profile rating (1-8 scale from BSCpro)
  profileRating   Int?

  // Status
  status          MatchupStatus @default(PENDING)

  // Notes
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([requestingAgentId])
  @@index([appointmentDate])
}

enum MatchupType {
  BPM_INVITE
  ONE_ON_ONE
  KITCHEN_TABLE
  FOLLOW_UP
  CLOSING
  RECRUIT_INTERVIEW
}

enum MatchupStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ============================================
// TEAM INVITE SYSTEM
// ============================================

model TeamInvite {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Inviter
  invitedById     String
  invitedBy       Agent    @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)

  // Invite details
  email           String
  firstName       String?
  lastName        String?
  role            AgentRole @default(AGENT)

  // Token for signup link
  token           String   @unique
  expiresAt       DateTime

  // Status
  status          InviteStatus @default(PENDING)
  acceptedAt      DateTime?
  acceptedById    String?  // The agent ID who accepted (after signup)

  createdAt       DateTime @default(now())

  @@index([organizationId])
  @@index([token])
  @@index([email])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ============================================
// BUSINESS BALANCE SHEET SYSTEM
// ============================================

model BusinessProspect {
  id        String   @id @default(cuid())
  email     String   @unique

  // Contact Person
  firstName String
  lastName  String
  phone     String?

  // Business Info
  businessName    String
  businessType    BusinessType @default(LLC)
  industry        String?
  yearsInBusiness Int          @default(1)
  employeeCount   Int          @default(1)

  // Status
  status    ProspectStatus @default(LEAD)

  // Agent ownership
  agentId   String?
  agent     Agent?   @relation("BusinessProspects", fields: [agentId], references: [id], onDelete: SetNull)

  // Referral tracking
  referredByAgentId String?
  referredByAgent   Agent?   @relation("ReferredBusinessProspects", fields: [referredByAgentId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  financialProfile BusinessFinancialProfile?

  @@index([agentId])
  @@index([referredByAgentId])
}

enum BusinessType {
  SOLE_PROPRIETORSHIP
  LLC
  PARTNERSHIP
  S_CORP
  C_CORP
  NONPROFIT
  OTHER
}

// Business Financial Profile
model BusinessFinancialProfile {
  id                String   @id @default(cuid())
  businessProspectId String  @unique
  businessProspect   BusinessProspect @relation(fields: [businessProspectId], references: [id], onDelete: Cascade)

  // ===== BUSINESS INCOME =====
  annualRevenue       Decimal @db.Decimal(14, 2) @default(0)
  grossProfit         Decimal @db.Decimal(14, 2) @default(0)
  netIncome           Decimal @db.Decimal(14, 2) @default(0)
  ownerSalary         Decimal @db.Decimal(12, 2) @default(0)
  ownerDistributions  Decimal @db.Decimal(12, 2) @default(0)

  // ===== BUSINESS ASSETS =====
  // Current Assets
  cashOnHand          Decimal @db.Decimal(14, 2) @default(0)
  accountsReceivable  Decimal @db.Decimal(14, 2) @default(0)
  inventory           Decimal @db.Decimal(14, 2) @default(0)
  prepaidExpenses     Decimal @db.Decimal(12, 2) @default(0)

  // Fixed Assets
  equipment           Decimal @db.Decimal(14, 2) @default(0)
  vehicles            Decimal @db.Decimal(14, 2) @default(0)
  realEstate          Decimal @db.Decimal(14, 2) @default(0)
  leaseholdImprovements Decimal @db.Decimal(14, 2) @default(0)

  // Other Assets
  intellectualProperty Decimal @db.Decimal(14, 2) @default(0)
  goodwill            Decimal @db.Decimal(14, 2) @default(0)
  investments         Decimal @db.Decimal(14, 2) @default(0)
  otherAssets         Decimal @db.Decimal(14, 2) @default(0)

  // ===== BUSINESS LIABILITIES =====
  // Current Liabilities
  accountsPayable     Decimal @db.Decimal(14, 2) @default(0)
  accruedExpenses     Decimal @db.Decimal(12, 2) @default(0)
  shortTermLoans      Decimal @db.Decimal(14, 2) @default(0)
  creditCards         Decimal @db.Decimal(12, 2) @default(0)
  lineOfCredit        Decimal @db.Decimal(14, 2) @default(0)
  currentPortionLTD   Decimal @db.Decimal(14, 2) @default(0) // Current portion of long-term debt

  // Long-Term Liabilities
  termLoans           Decimal @db.Decimal(14, 2) @default(0)
  sbaLoans            Decimal @db.Decimal(14, 2) @default(0)
  equipmentLoans      Decimal @db.Decimal(14, 2) @default(0)
  commercialMortgage  Decimal @db.Decimal(14, 2) @default(0)
  otherLongTermDebt   Decimal @db.Decimal(14, 2) @default(0)

  // ===== BUSINESS INSURANCE =====
  keyPersonInsurance      Decimal @db.Decimal(12, 2) @default(0)
  generalLiability        Decimal @db.Decimal(12, 2) @default(0)
  professionalLiability   Decimal @db.Decimal(12, 2) @default(0) // E&O
  propertyInsurance       Decimal @db.Decimal(12, 2) @default(0)
  workersComp             Decimal @db.Decimal(12, 2) @default(0)
  businessInterruption    Decimal @db.Decimal(12, 2) @default(0)
  cyberLiability          Decimal @db.Decimal(12, 2) @default(0)
  buyerSellerAgreement    Boolean @default(false)
  successionPlan          Boolean @default(false)

  // ===== CALCULATED FIELDS =====
  totalAssets         Decimal @db.Decimal(14, 2) @default(0)
  totalLiabilities    Decimal @db.Decimal(14, 2) @default(0)
  netWorth            Decimal @db.Decimal(14, 2) @default(0)
  currentRatio        Decimal @db.Decimal(6, 2) @default(0)
  debtToEquityRatio   Decimal @db.Decimal(6, 2) @default(0)

  // ===== PROTECTION GAPS =====
  keyPersonGap        Decimal @db.Decimal(14, 2) @default(0)
  buyoutFundingGap    Decimal @db.Decimal(14, 2) @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
